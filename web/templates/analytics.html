{% extends "base.html" %}

{% block header_title %}Analytics Dashboard{% endblock %}
{% block header_subtitle %}Detailed statistics and performance metrics for QuranBot{% endblock %}

{% block content %}
<!-- Analytics Overview -->
<div class="grid-3 fade-in-up">
    <div class="card">
        <h3>
            <span class="icon">ğŸ“Š</span>
            Quiz Analytics
        </h3>
        <div class="metric">
            <span class="metric-label">Total Questions</span>
            <span class="metric-value" id="total-questions">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Correct Answers</span>
            <span class="metric-value" id="correct-answers">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Average Accuracy</span>
            <span class="metric-value" id="average-accuracy">Loading...</span>
        </div>
    </div>

    <div class="card">
        <h3>
            <span class="icon">ğŸµ</span>
            Audio Analytics
        </h3>
        <div class="metric">
            <span class="metric-label">Total Listening Time</span>
            <span class="metric-value" id="total-listening-time">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Sessions Today</span>
            <span class="metric-value" id="sessions-today">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Most Played Surah</span>
            <span class="metric-value" id="most-played-surah">Loading...</span>
        </div>
    </div>

    <div class="card">
        <h3>
            <span class="icon">ğŸ‘¥</span>
            User Analytics
        </h3>
        <div class="metric">
            <span class="metric-label">Active Users</span>
            <span class="metric-value" id="active-users">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Daily Active Users</span>
            <span class="metric-value" id="daily-active-users">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Total Interactions</span>
            <span class="metric-value" id="total-interactions">Loading...</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid-2 fade-in-up">
    <div class="card">
        <h3>
            <span class="icon">ğŸ“ˆ</span>
            Quiz Performance Trend
        </h3>
        <div class="chart-container">
            <canvas id="quiz-performance-chart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>
            <span class="icon">ğŸ§</span>
            Listening Activity
        </h3>
        <div class="chart-container">
            <canvas id="listening-activity-chart"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="card fade-in-up">
    <h3>
        <span class="icon">ğŸ”</span>
        Detailed Analytics
    </h3>
    
    <div class="grid-2">
        <div>
            <h4>ğŸ“Š Quiz Statistics</h4>
            <div class="metric">
                <span class="metric-label">Questions Asked Today</span>
                <span class="metric-value" id="questions-today">Loading...</span>
            </div>
            <div class="metric">
                <span class="metric-label">Participation Rate</span>
                <span class="metric-value" id="participation-rate">Loading...</span>
            </div>
            <div class="metric">
                <span class="metric-label">Average Response Time</span>
                <span class="metric-value" id="avg-response-time">Loading...</span>
            </div>
        </div>
        
        <div>
            <h4>ğŸµ Audio Statistics</h4>
            <div class="metric">
                <span class="metric-label">Hours Streamed Today</span>
                <span class="metric-value" id="hours-streamed">Loading...</span>
            </div>
            <div class="metric">
                <span class="metric-label">Skip Rate</span>
                <span class="metric-value" id="skip-rate">Loading...</span>
            </div>
            <div class="metric">
                <span class="metric-label">Favorite Reciter</span>
                <span class="metric-value" id="favorite-reciter">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Top Performers -->
<div class="card fade-in-up">
    <h3>
        <span class="icon">ğŸ†</span>
        Top Performers This Week
    </h3>
    <div id="top-performers-container">
        <div class="loading-card">
            <div class="loading"></div>
            <p>Loading top performers...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Analytics page JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize analytics dashboard
    if (typeof dashboard !== 'undefined') {
        dashboard.initAnalytics();
    }
    
    // Update analytics data
    updateAnalyticsData();
    
    // Set up auto-refresh
    setInterval(updateAnalyticsData, 30000); // Every 30 seconds
});

function updateAnalyticsData() {
    // Update quiz analytics
    fetch('/api/quiz/stats')
        .then(response => response.json())
        .then(data => {
            if (data.total_questions !== undefined) {
                document.getElementById('total-questions').textContent = data.total_questions;
                document.getElementById('correct-answers').textContent = data.correct_answers || 0;
                document.getElementById('average-accuracy').textContent = 
                    data.average_accuracy ? data.average_accuracy.toFixed(1) + '%' : '0%';
                document.getElementById('questions-today').textContent = data.questions_today || 0;
                document.getElementById('participation-rate').textContent = 
                    data.participation_rate ? data.participation_rate.toFixed(1) + '%' : '0%';
                document.getElementById('avg-response-time').textContent = 
                    data.avg_response_time || 'N/A';
            }
        })
        .catch(error => console.error('Error fetching quiz stats:', error));

    // Update listening analytics
    fetch('/api/listening/stats')
        .then(response => response.json())
        .then(data => {
            if (data.total_listening_time !== undefined) {
                document.getElementById('total-listening-time').textContent = 
                    formatDuration(data.total_listening_time);
                document.getElementById('sessions-today').textContent = data.sessions_today || 0;
                document.getElementById('most-played-surah').textContent = 
                    data.most_played_surah || 'N/A';
                document.getElementById('hours-streamed').textContent = 
                    data.hours_streamed ? data.hours_streamed.toFixed(1) + 'h' : '0h';
                document.getElementById('skip-rate').textContent = 
                    data.skip_rate ? data.skip_rate.toFixed(1) + '%' : '0%';
                document.getElementById('favorite-reciter').textContent = 
                    data.favorite_reciter || 'N/A';
            }
        })
        .catch(error => console.error('Error fetching listening stats:', error));

    // Update user analytics (placeholder)
    document.getElementById('active-users').textContent = '42';
    document.getElementById('daily-active-users').textContent = '28';
    document.getElementById('total-interactions').textContent = '1,247';
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

console.log('ğŸ“Š Analytics page scripts loaded');
</script>
{% endblock %} 